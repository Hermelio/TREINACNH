{% extends 'base.html' %}
{% block title %}Enviar Documento | TreinaCNH{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4">

    {# Main form #}
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white d-flex align-items-center gap-2">
          <i class="bi bi-cloud-upload-fill fs-5"></i>
          <h5 class="mb-0">Enviar Documento para Verificacao</h5>
        </div>
        <div class="card-body p-4">

          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="docUploadForm" novalidate>
            {% csrf_token %}

            <div class="mb-4">
              <label for="{{ form.doc_type.id_for_label }}" class="form-label fw-semibold">
                {{ form.doc_type.label }}
              </label>
              {{ form.doc_type }}
              {% if form.doc_type.errors %}
                <div class="invalid-feedback d-block">{{ form.doc_type.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="mb-4">
              <label for="{{ form.file.id_for_label }}" class="form-label fw-semibold">
                {{ form.file.label }}
              </label>
              {{ form.file }}
              <div class="form-text text-muted">{{ form.file.help_text }}</div>
              {% if form.file.errors %}
                <div class="invalid-feedback d-block">{{ form.file.errors.0 }}</div>
              {% endif %}
              <div id="filePreview" class="mt-3 d-none">
                <p class="small text-muted mb-1">Pre-visualizacao:</p>
                <img id="filePreviewImg" src="#" alt="Pre-visualizacao" class="img-thumbnail d-none" style="max-height:220px;">
                <div id="filePreviewPdf" class="alert alert-secondary py-2 px-3 small d-none">
                  <i class="bi bi-file-earmark-pdf-fill text-danger me-1"></i>
                  Arquivo PDF selecionado.
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label for="{{ form.selfie.id_for_label }}" class="form-label fw-semibold">
                {{ form.selfie.label }}
                <span class="badge bg-secondary ms-1" style="font-size:.7rem;">Opcional</span>
              </label>
              {{ form.selfie }}
              <div class="form-text text-muted">{{ form.selfie.help_text }}</div>
              {% if form.selfie.errors %}
                <div class="invalid-feedback d-block">{{ form.selfie.errors.0 }}</div>
              {% endif %}
              <div id="selfiePreview" class="mt-3 d-none">
                <p class="small text-muted mb-1">Pre-visualizacao da selfie:</p>
                <img id="selfiePreviewImg" src="#" alt="Selfie" class="img-thumbnail rounded-circle" style="max-height:140px;max-width:140px;object-fit:cover;">
              </div>
            </div>

            <div class="d-flex gap-2 justify-content-end mt-3">
              <a href="{% url 'verification:my_documents' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Voltar
              </a>
              <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                <i class="bi bi-send-fill me-1"></i>Enviar Documento
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {# Sidebar #}
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light fw-semibold">
          <i class="bi bi-list-check me-1"></i>Documentos Necessarios
        </div>
        <ul class="list-group list-group-flush">

          {% with doc=existing_docs.CNH %}
          <li class="list-group-item d-flex align-items-start gap-2 py-3">
            {% if doc and doc.status == 'APPROVED' %}<span class="text-success fs-5 mt-1">&#x2705;</span>
            {% elif doc and doc.status == 'PENDING' %}<span class="text-warning fs-5 mt-1">&#x23F3;</span>
            {% elif doc and doc.status == 'REJECTED' %}<span class="text-danger fs-5 mt-1">&#x274C;</span>
            {% else %}<span class="text-secondary fs-5 mt-1">&#x2B1C;</span>{% endif %}
            <div>
              <strong>CNH</strong>
              <div class="small text-muted">Carteira Nacional de Habilitacao</div>
              {% if doc %}
                <span class="badge {% if doc.status == 'APPROVED' %}bg-success{% elif doc.status == 'PENDING' %}bg-warning text-dark{% else %}bg-danger{% endif %} mt-1">{{ doc.get_status_display }}</span>
              {% endif %}
            </div>
          </li>
          {% endwith %}

          {% with doc=existing_docs.CERT_INSTRUTOR %}
          <li class="list-group-item d-flex align-items-start gap-2 py-3">
            {% if doc and doc.status == 'APPROVED' %}<span class="text-success fs-5 mt-1">&#x2705;</span>
            {% elif doc and doc.status == 'PENDING' %}<span class="text-warning fs-5 mt-1">&#x23F3;</span>
            {% elif doc and doc.status == 'REJECTED' %}<span class="text-danger fs-5 mt-1">&#x274C;</span>
            {% else %}<span class="text-secondary fs-5 mt-1">&#x2B1C;</span>{% endif %}
            <div>
              <strong>Certificado de Instrutor</strong>
              <div class="small text-muted">Emitido pelo DETRAN ou escola credenciada</div>
              {% if doc %}
                <span class="badge {% if doc.status == 'APPROVED' %}bg-success{% elif doc.status == 'PENDING' %}bg-warning text-dark{% else %}bg-danger{% endif %} mt-1">{{ doc.get_status_display }}</span>
              {% endif %}
            </div>
          </li>
          {% endwith %}

          <li class="list-group-item d-flex align-items-start gap-2 py-3">
            <span class="text-info fs-5 mt-1">&#x1F4F8;</span>
            <div>
              <strong>Selfie com documento</strong> <span class="badge bg-secondary">Opcional</span>
              <div class="small text-muted">Acelera a aprovacao. Segure o documento visivel.</div>
            </div>
          </li>
        </ul>
      </div>

      <div class="card shadow-sm border-0 border-start border-4 border-primary">
        <div class="card-body p-3 small">
          <p class="fw-semibold mb-2"><i class="bi bi-info-circle-fill text-primary me-1"></i>Dicas</p>
          <ul class="mb-0 ps-3">
            <li>PDF ou imagem (JPG, PNG)</li>
            <li>Tamanho maximo: <strong>10 MB</strong> por arquivo</li>
            <li>Imagens nitidas, sem borroes</li>
            <li>Prazo de analise: <strong>1 a 3 dias uteis</strong></li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  function setupPreview(inputId, imgId, pdfMsgId, wrapId) {
    var input = document.getElementById(inputId);
    var img   = imgId   ? document.getElementById(imgId)   : null;
    var pdf   = pdfMsgId ? document.getElementById(pdfMsgId) : null;
    var wrap  = document.getElementById(wrapId);
    if (!input || !wrap) return;
    input.addEventListener('change', function () {
      var file = this.files[0];
      if (!file) { wrap.classList.add('d-none'); return; }
      wrap.classList.remove('d-none');
      if (file.type === 'application/pdf') {
        if (img) img.classList.add('d-none');
        if (pdf) pdf.classList.remove('d-none');
        return;
      }
      var reader = new FileReader();
      reader.onload = function (e) {
        if (img) { img.src = e.target.result; img.classList.remove('d-none'); }
        if (pdf) pdf.classList.add('d-none');
      };
      reader.readAsDataURL(file);
    });
  }

  setupPreview('id_file',   'filePreviewImg',   'filePreviewPdf', 'filePreview');
  setupPreview('id_selfie', 'selfiePreviewImg', null,             'selfiePreview');

  document.getElementById('docUploadForm').addEventListener('submit', function () {
    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';
  });
})();
</script>
{% endblock %}
