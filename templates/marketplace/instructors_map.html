{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Header with filters -->
    <div class="bg-light py-3 border-bottom">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0">
                        <i class="bi bi-geo-alt-fill text-primary"></i>
                        Instrutores em {{ current_state.name|default:"Todos os Estados" }}
                    </h4>
                    <small class="text-muted">{{ instructors_count }} instrutores encontrados</small>
                </div>
                <div class="col-md-6">
                    <form method="get" class="row g-2">
                        <div class="col-md-4">
                            <select name="state" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Todos os estados</option>
                                {% for state in states %}
                                    <option value="{{ state.code }}" {% if current_state_code == state.code %}selected{% endif %}>
                                        {{ state.code }} - {{ state.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="category" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Todas as categorias</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.code }}" {% if selected_category == cat.code %}selected{% endif %}>
                                        {{ cat.label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="gender" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Qualquer gênero</option>
                                <option value="M" {% if selected_gender == "M" %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if selected_gender == "F" %}selected{% endif %}>Feminino</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Map and List -->
    <div class="row g-0">
        <!-- Map Column -->
        <div class="col-lg-8">
            <div id="map" style="height: calc(100vh - 180px); min-height: 500px;"></div>
        </div>

        <!-- Instructors List Column -->
        <div class="col-lg-4 border-start" style="height: calc(100vh - 180px); overflow-y: auto;">
            <div class="p-3">
                {% if instructors %}
                    {% for instructor in instructors %}
                        <div class="card mb-3 instructor-card" 
                             data-lat="{{ instructor.latitude }}" 
                             data-lng="{{ instructor.longitude }}"
                             data-id="{{ instructor.id }}"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <img src="{% if instructor.user.profile.avatar %}{{ instructor.user.profile.avatar.url }}{% else %}/static/img/avatar-placeholder.png{% endif %}" 
                                         alt="{{ instructor.user.get_full_name }}" 
                                         class="rounded-circle me-3"
                                         style="width: 60px; height: 60px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            {{ instructor.user.get_full_name }}
                                            {% if instructor.is_verified %}
                                                <i class="bi bi-patch-check-fill text-primary" title="Verificado"></i>
                                            {% endif %}
                                        </h6>
                                        
                                        <div class="d-flex gap-1 mb-2">
                                            {% for badge in instructor.badges %}
                                                <span class="badge bg-{{ badge.1 }} small">{{ badge.0 }}</span>
                                            {% endfor %}
                                        </div>

                                        {% if instructor.address_neighborhood %}
                                            <p class="small text-muted mb-1">
                                                <i class="bi bi-geo-alt"></i> {{ instructor.address_neighborhood }}, {{ instructor.city.name }}
                                            </p>
                                        {% endif %}

                                        <div class="small mb-2">
                                            {% if instructor.average_rating %}
                                                <span class="text-warning">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= instructor.average_rating %}
                                                            <i class="bi bi-star-fill"></i>
                                                        {% else %}
                                                            <i class="bi bi-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </span>
                                                <span class="text-muted">({{ instructor.review_count }})</span>
                                            {% endif %}
                                        </div>

                                        <div class="d-flex gap-2">
                                            <a href="{% url 'marketplace:instructor_detail' instructor.id %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Ver perfil
                                            </a>
                                            {% if instructor.user.profile.whatsapp_number %}
                                                <a href="{{ instructor.get_whatsapp_link }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-success">
                                                    <i class="bi bi-whatsapp"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search fs-1 text-muted"></i>
                        <p class="text-muted">Nenhum instrutor encontrado com esses filtros.</p>
                        <a href="{% url 'marketplace:instructors_map' %}" class="btn btn-primary">Limpar filtros</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Initialize map
    const map = L.map('map').setView([-15.7942, -47.8822], 4); // Center of Brazil

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Custom icon for instructors
    const instructorIcon = L.divIcon({
        className: 'custom-instructor-marker',
        html: `
            <div style="
                background: #0d6efd;
                border: 3px solid white;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            ">
                <i class="bi bi-person-circle text-white" style="font-size: 18px;"></i>
            </div>
        `,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
    });

    // Instructors data
    const instructors = {{ instructors_json|safe }};

    // Create markers
    const markers = {};
    instructors.forEach(instructor => {
        if (instructor.latitude && instructor.longitude) {
            const marker = L.marker(
                [instructor.latitude, instructor.longitude],
                { icon: instructorIcon }
            ).addTo(map);
            
            // Popup content
            const popupContent = `
                <div style="min-width: 200px;">
                    <h6>${instructor.name} 
                        ${instructor.is_verified ? '<i class="bi bi-patch-check-fill text-primary"></i>' : ''}
                    </h6>
                    <p class="small mb-2">${instructor.neighborhood || instructor.city}</p>
                    <a href="/instrutores/${instructor.id}/" class="btn btn-sm btn-primary w-100">Ver perfil</a>
                </div>
            `;
            marker.bindPopup(popupContent);
            markers[instructor.id] = marker;
        }
    });

    // Adjust map bounds if we have markers
    if (instructors.length > 0) {
        const hasCoordinates = instructors.filter(i => i.latitude && i.longitude);
        if (hasCoordinates.length > 0) {
            const bounds = L.latLngBounds(hasCoordinates.map(i => [i.latitude, i.longitude]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // Click on card to highlight marker
    document.querySelectorAll('.instructor-card').forEach(card => {
        card.addEventListener('click', function() {
            const instructorId = this.dataset.id;
            const marker = markers[instructorId];
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
        });
    });
</script>

<style>
    .instructor-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        transition: all 0.2s;
    }
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
</style>
{% endblock %}
